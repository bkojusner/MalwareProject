#include "stdio.h"
#include "sys/socket.h"
#include "errno.h"
#include "netdb.h"
#include "string.h"
#include "stdlib.h"
#include <unistd.h>
#include <sys/types.h>
#include <netinet/in.h>
#include <arpa/inet.h>

int main(int argc , char **argv)
{
	int err, i, sock;
	int start = 135;
	int end = 137;
    char hostname[100];
	int iter = 0;
	char* IP;
	char* LoopIP;
	struct hostent* host_entry;
	int host;
	host = gethostname(hostname, sizeof(hostname));	//find host name
	if (host == -1) {
		perror("gethostname");
		exit(1);
	}
	host_entry = gethostbyname(hostname);	//find host info
	if (host_entry == NULL) {
		perror("gethostbyname");
		exit(1);
	}
	IP = inet_ntoa(*((struct in_addr*) host_entry->h_addr_list[0]));	//Convert to IP
	printf("Currnet Host Name: %s\n", hostname);
	printf("Current IP is: %s\n", IP);
	int IPnumber[4];
	char* token;
	char* rest = IP;
	int k = 0;
	while ((token = strtok_r(rest, ".", &rest))) {
		printf("%s\n", token);
		if (k != 3) {
			strcat(LoopIP, token);
			strcat(LoopIP,".");
		}
		k++;
	}
	char fuck[10];
	printf("%d.%d.%d.%d", IPnumber[0], IPnumber[1], IPnumber[2], IPnumber[3]);
	for (int i = 0; i < 10; i++) {
		snprintf(fuck, sizeof(fuck), "%d", i);
		strcat(LoopIP, fuck);
		printf("%s\n", IP);
	}
    struct sockaddr_in sa;
     
    //Get the hostname to scan

    //printf("Enter hostname or IP : ");
    //gets(hostname);
     
    //Get start port number
    //printf("\nEnter start port number : ");
    //scanf("%d" , &start);
     
    //Get end port number
    //printf("Enter end port number : ");
    //scanf("%d" , &end);
 
    //Initialise the sockaddr_in structure
    strncpy((char*)&sa , "" , sizeof sa);
    sa.sin_family = AF_INET;
    //direct ip address, use it
    if(isdigit(hostname[0]))
    {
        printf("Doing inet_addr...");
        sa.sin_addr.s_addr = inet_addr(hostname);
        printf("Done\n");
    }
    //Resolve hostname to ip address
    else if( (host = gethostbyname(hostname)) != 0)
    {
        printf("Doing gethostbyname...");
        strncpy((char*)&sa.sin_addr , (char*)host_entry->h_addr , sizeof sa.sin_addr);
        printf("Done\n");
    }
    else
    {
        herror(hostname);
        exit(2);
    }
     
    //Start the port scan loop
	FILE* fp;
	fp = fopen("ips.txt","w");

    printf("Starting the portscan loop : \n");
    for( i = start ; i <= end ; i++) 
    {
        //Fill in the port number
        sa.sin_port = htons(i);
        //Create a socket of type internet
        sock = socket(AF_INET , SOCK_STREAM , 0);
         
        //Check whether socket created fine or not
        if(sock < 0) 
        {
            perror("\nSocket");
            exit(1);
        }
        //Connect using that socket and sockaddr structure
        err = connect(sock , (struct sockaddr*)&sa , sizeof sa);
         
        //not connected
        if( err < 0 )
        {
            //printf("%s %-5d %s\r" , hostname , i, strerror(errno));
            fflush(stdout);
        }
        //connected
        else
        {
            printf("%-5d open\n",  i);
			fprintf(fp, hostname);

        }
        close(sock);
    }
	fclose(fp);
     
    printf("\r");
    fflush(stdout);
    return(0);
}
