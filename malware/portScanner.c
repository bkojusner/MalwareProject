#include "stdio.h"
#include "sys/socket.h"
#include "errno.h"
#include "netdb.h"
#include "string.h"
#include "stdlib.h"
#include <unistd.h>
#include <sys/types.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <net/if.h>
#include <sys/ioctl.h>

int main(int argc , char **argv)
{

	int err, sock;
	int start = 442;
	int end = 446;
	int iter = 0;
	char* IP;
	char* LoopIP;
	struct hostent* host_entry;
	int host;
	int fd;
	struct ifreq ifr;

	fd = socket(AF_INET, SOCK_DGRAM, 0);


	ifr.ifr_addr.sa_family = AF_INET;

	strncpy(ifr.ifr_name, "ens160", IFNAMSIZ-1);

	ioctl(fd, SIOCGIFADDR, &ifr);

	close(fd);
	char hostname[100];
	strcpy(hostname, inet_ntoa(((struct sockaddr_in *)&ifr.ifr_addr)->sin_addr));

    struct sockaddr_in sa;
     
    //Get the hostname to scan

    //printf("Enter hostname or IP : ");
    //fgets(hostname, 20, stdin);
	char subnet[20];
	int strlength;
	strlength = strlen(hostname);
	//printf("length of hostname is: %d\n", strlength);
	memcpy( subnet, hostname, strlength-3);
	subnet[strlength-3] = 0;
	//printf("hostname is: %s\n", hostname);
	//printf("subnet is: %s\n", subnet);
     
    //Get start port number
    //printf("\nEnter start port number : ");
    //scanf("%d" , &start);
     
    //Get end port number
    //printf("Enter end port number : ");
    //scanf("%d" , &end);

    FILE* fp;
    fp = fopen("ips.txt", "w");
    for(int k = 1; k < 255; k++){
    char loopIP[20];
    strcpy(loopIP, subnet);
    char dot[] = ".";
    char number[4];
    sprintf(number, "%d", k);
    strcat(loopIP, dot);
    strcat(loopIP, number);
    //printf("%s\n", loopIP);
    
    //Initialise the sockaddr_in structure
    strncpy((char*)&sa , "" , sizeof sa);
    sa.sin_family = AF_INET;
    //direct ip address, use it
    if(isdigit(loopIP[0]))
    {
        //printf("Doing inet_addr...");
        sa.sin_addr.s_addr = inet_addr(loopIP);
        //printf("Done\n");
    }
    //Resolve hostname to ip address
    else if( (host = gethostbyname(loopIP)) != 0)
    {
        //printf("Doing gethostbyname...");
        strncpy((char*)&sa.sin_addr , (char*)host_entry->h_addr , sizeof sa.sin_addr);
        //printf("Done\n");
    }
    else
    {
        herror(loopIP);
        exit(2);
    }
     
    //Start the port scan loop
    printf("Starting the portscan loop :\n");
    for(int i = 139 ; i <= 139 ; i++) 
    {
        //Fill in the port number
	printf("Scanning %s:%d\n", loopIP, i);
	fflush(stdout);
        sa.sin_port = htons(i);
        //Create a socket of type internet
        sock = socket(AF_INET , SOCK_STREAM , 0);
        //printf("Scanning port number %d", i);
        //Check whether socket created fine or not
        if(sock < 0) 
        {
            perror("\nSocket");
            exit(1);
        }
        //Connect using that socket and sockaddr structure
        err = connect(sock , (struct sockaddr*)&sa , sizeof sa);
         
        //not connected
        if( err < 0 )
        {
            //printf("%s %-5d %s\r" , hostname , i, strerror(errno));
            fflush(stdout);
        }
        //connected
        else
        {
            printf("%-5d open\n",  i);
			fprintf(fp, loopIP);

        }
        close(sock);
    }
	fclose(fp);
    }
    printf("\r");
    fflush(stdout);
    return(0);
}
